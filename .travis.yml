language: generic

matrix:
  include:
    - os: linux
      env: PYTHON=2.7
    - os: linux
      env: PYTHON=3.5
    - os: linux
      env: PYTHON=3.6
    - os: linux
      env: PYTHON=3.7
    - os: linux
      env: PYTHON=3.7 SKIP_TESTS=true
    - os: linux
      env: PYTHON=3.7 SKIP_TESTS=true BUILD_DOCS=true
    - os: osx
      env: PYTHON=3.7
    - os: osx
      env: PYTHON=3.7 SKIP_TESTS=true

sudo: false

addons:
    apt:
        packages:
            libfftw3-dev
            texlive-latex-base
            texlive-latex-recommended
            texlive-latex-extra
            dvipng

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi

# Setup numpy + scipy using miniconda
# See http://conda.pydata.org/docs/travis.html
install:
    # Install miniconda according to Python version of the build (saves download bandwidth if versions match)
    - if [[ "$PYTHON" == "2.7" ]]; then
        export _MINICONDA=Miniconda2;
      else
        export _MINICONDA=Miniconda3;
      fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        export _OS=MacOSX;
      else
        export _OS=Linux;
      fi
    - wget -q https://repo.continuum.io/miniconda/${_MINICONDA}-latest-${_OS}-x86_64.sh -O miniconda.sh
    - chmod +x miniconda.sh
    - ./miniconda.sh -b -p $HOME/miniconda
    - export PATH="$HOME/miniconda/bin:$PATH"
    - hash -r
    - conda config --set always_yes yes --set changeps1 no
    # Useful for debugging any issues with conda
    - conda info -a

    # Install dependencies and enter test environment
    - conda create -n testenv
    - source activate testenv
    - conda config --env --add channels conda-forge
    - conda install python=$PYTHON "numpy<1.16.0" nfft cython pytest

    # Doc dependencies
    - if [[ "$BUILD_DOCS" == "true" ]]; then
        pip install "sphinx>=1.7" "travis-sphinx>=2.1.2";
      fi

    # Build and install our package
    - if [[ $TRAVIS_OS_NAME == "osx" ]]; then
        pip install -e . -vv;
      else
        CFLAGS="-I$CONDA_PREFIX/include" LDFLAGS="-L$CONDA_PREFIX/lib" pip install -e . -vv;
      fi

script:
    # Run tests and produce a coverage report.
    # Also invoke the alternative way of running the unit tests.
    # Fail immediately after first failure to speed up the whole thing.
    - if [[ "$SKIP_TESTS" != "true" ]]; then
        pytest -v --doctest-modules pynfft/ || exit -1;
      fi
    # Build the Sphinx doc (only for one specific build, master branch, no PR)
    # To avoid clogging the logs, we redirect stderr to /dev/null
    - if [[ "$BUILD_DOCS" == "true" ]]; then
        cd doc && make html 2>/dev/null || exit -1;
      fi

after_success:
    # TODO: how to deploy the docs?

